#include "stm32f10x.h"   // 相当于51单片机中的  #include<reg51.h>
#include "bsp_led.h"
#include "bsp_key.h"
#include "stdio.h"
#include "bsp_usart.h"
#include "arm_math.h"

#define TEST_LENGTH_SAMPLES  542  //512+30     /* 采样点数 */
#define BLOCK_SIZE           2     /* 调用一次arm_fir_f32处理的采样点个数 */
#define NUM_TAPS             30     /* 滤波器系数个数 */
 
uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;            /* 需要调用arm_fir_f32的次数 */
char floatTOchar [10] = ""; 

static float32_t testOutput[TEST_LENGTH_SAMPLES];               /* 滤波后的输出 */
static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];        /* 状态缓存，大小numTaps + blockSize - 1*/
static float32_t testInput_f32_50Hz_200Hz[TEST_LENGTH_SAMPLES] ={
232.427,
232.501,
232.427,
232.501,
232.448,
232.453,
232.347,
232.315,
232.331,
232.357,
232.4,
232.405,
232.464,
232.469,
232.427,
232.267,
232.443,
232.373,
232.357,
232.448,
232.325,
232.427,
232.357,
232.341,
232.24,
232.336,
232.315,
232.325,
232.336,
232.331,
232.384,
232.597,
232.427,
232.501,
232.448,
232.453,
232.347,
232.315,
232.331,
232.357,
232.4,
232.405,
232.464,
232.469,
232.427,
232.267,
232.443,
232.373,
232.357,
232.448,
232.325,
232.427,
232.357,
232.341,
232.24,
232.336,
232.315,
232.325,
232.336,
232.331,
232.437,
232.368,
232.379,
232.325,
232.357,
232.432,
232.352,
232.341,
232.357,
232.405,
232.341,
232.421,
232.389,
232.421,
232.427,
232.368,
232.437,
232.331,
232.331,
232.517,
232.437,
232.357,
232.533,
232.587,
232.613,
232.539,
232.432,
232.608,
232.613,
232.843,
232.672,
232.555,
232.853,
232.875,
232.491,
232.352,
232.421,
232.8,
232.843,
232.736,
232.635,
232.693,
232.597,
231.915,
231.099,
230.752,
230.315,
230.725,
232.427,
232.427,
232.437,
232.443,
232.96,
232.795,
232.848,
232.763,
232.475,
232.608,
232.629,
232.459,
232.523,
232.544,
232.576,
232.613,
232.629,
232.629,
232.475,
232.453,
232.459,
232.88,
232.608,
232.629,
232.427,
232.309,
232.517,
232.389,
232.4,
232.619,
232.389,
232.224,
232.512,
232.512,
232.459,
232.347,
232.363,
232.251,
232.192,
232.272,
232.144,
232.24,
232.149,
231.696,
230.715,
230.192,
230.224,
230.229,
231.44,
231.909,
232.24,
232.155,
232.155,
232.133,
232.053,
231.973,
231.941,
231.963,
232.128,
231.984,
231.92,
231.989,
232.043,
231.941,
231.915,
231.915,
231.931,
231.845,
232.005,
231.936,
231.824,
232.011,
231.936,
232.133,
232.032,
231.915,
231.941,
232.032,
231.947,
231.867,
232.219,
232.165,
231.925,
231.669,
232.133,
232.139,
232.149,
232.213,
232.229,
232.149,
232.059,
232.395,
232.299,
231.861,
231.973,
231.931,
232.315,
232,
232.389,
231.904,
232.405,
232.352,
232.171,
232.128,
232.368,
232.117,
232.347,
232.181,
232.165,
232.059,
232.128,
232.272,
232.325,
232.016,
232.315,
231.989,
232.149,
232.059,
232.128,
232.32,
232.16,
232.165,
232.139,
231.989,
232.123,
232,
232.32,
231.984,
232.053,
232.059,
232.107,
231.771,
232.261,
232.224,
231.947,
231.979,
231.92,
232.224,
232.139,
231.952,
232.128,
231.957,
231.845,
231.851,
231.669,
231.712,
231.904,
231.915,
231.915,
231.925,
231.931,
231.925,
231.867,
231.963,
232.075,
231.904,
232.352,
231.915,
231.915,
231.861,
232.128,
231.856,
231.733,
231.723,
231.915,
231.835,
231.872,
231.947,
231.915,
231.904,
231.92,
231.856,
231.739,
231.925,
232.064,
231.957,
231.861,
231.915,
231.755,
231.915,
231.92,
231.904,
231.787,
231.92,
231.92,
231.904,
232.059,
231.845,
231.829,
232.048,
231.936,
231.931,
231.909,
231.829,
231.899,
231.824,
232.037,
232.011,
231.936,
231.904,
231.925,
231.915,
232.048,
231.941,
232.037,
231.931,
232.133,
232.128,
231.995,
232.069,
232.139,
232.133,
232.144,
232.155,
232.245,
232.219,
232.395,
232.421,
232.235,
232.256,
232.16,
232.139,
232.261,
232.341,
232.427,
232.187,
232.133,
232.443,
232.384,
232.427,
232.432,
232.4,
232.251,
232.491,
232.267,
232.325,
232.528,
232.453,
232.475,
232.496,
232.603,
232.448,
232.437,
232.501,
232.485,
232.832,
232.661,
232.88,
232.64,
232.539,
232.517,
232.725,
232.8,
232.688,
232.688,
232.832,
232.832,
232.741,
232.843,
232.672,
232.507,
232.613,
232.619,
232.608,
232.613,
232.613,
232.587,
232.624,
232.619,
232.565,
232.528,
232.624,
232.704,
232.624,
232.517,
232.512,
232.72,
232.72,
232.576,
232.405,
232.608,
232.619,
232.485,
232.603,
232.624,
232.475,
232.688,
232.619,
232.432,
232.523,
232.453,
232.453,
232.453,
232.443,
232.229,
232.613,
232.635,
232.613,
232.208,
232.549,
232.864,
232.437,
232.603,
232.427,
232.437,
232.427,
232.613,
232.832,
232.661,
232.416,
232.507,
232.453,
232.373,
232.336,
232.8,
232.448,
232.592,
232.608,
232.448,
232.432,
232.32,
232.347,
232.421,
232.352,
232.469,
232.48,
232.507,
232.427,
232.581,
232.603,
232.549,
232.4,
232.437,
232.592,
232.459,
232.597,
232.341,
232.693,
232.507,
232.443,
232.549,
232.715,
232.661,
232.523,
232.475,
232.619,
232.608,
232.715,
232.496,
232.763,
232.859,
232.672,
232.507,
232.853,
232.421,
232.683,
232.72,
232.709,
232.507,
232.613,
232.608,
232.688,
232.608,
232.485,
232.437,
232.421,
232.288,
232.704,
232.613,
232.576,
232.4,
232.613,
232.384,
232.597,
232.427,
232.501,
232.448,
232.453,
232.347,
232.315,
232.331,
232.357,
232.4,
232.405,
232.464,
232.469,
232.427,
232.267,
232.443,
232.373,
232.357,
232.448,
232.325,
232.427,
232.357,
232.341,
232.24,
232.336,
232.315,
232.325,
232.336,
232.331,
232.437,
232.368,
232.379,
232.325,
232.357,
232.432,
232.352,
232.341,
232.357,
232.405,
232.341,
232.421,
232.389,
232.421,
232.427,
232.368,
232.437,
232.331,
232.331,
232.517,
232.437,
232.357,
232.533,
232.587,
232.613,
232.539,
232.432,
232.608,
232.613,
232.843,
232.672,
232.555,}; /* 采样点 */

void arm_fir_f32_lp();

			
			
/* 低通滤波器系数 通过fadtool获取*/
const float32_t firCoeffs32LP[NUM_TAPS] =   {
   0.004936690866748, 0.005626533676114, 0.007628538054799,  0.01086487508882,
    0.01519653586089,  0.02042971411469,  0.02632496655762,  0.03260870639446,
    0.03898646408759,  0.04515725627291,   0.0508283442016,  0.05572964026369,
    0.05962703640287,  0.06233398088215,  0.06372071727504,  0.06372071727504,
    0.06233398088215,  0.05962703640287,  0.05572964026369,   0.0508283442016,
    0.04515725627291,  0.03898646408759,  0.03260870639446,  0.02632496655762,
    0.02042971411469,  0.01519653586089,  0.01086487508882, 0.007628538054799,
   0.005626533676114, 0.004936690866748
};


/*
*********************************************************************************************************
*        函 数 名: arm_fir_f32_lp
*        功能说明: 调用函数arm_fir_f32_lp实现低通滤波器
*        形    参：无
*        返 回 值: 无
*********************************************************************************************************
*/
void arm_fir_f32_lp()
{
uint32_t i;
arm_fir_instance_f32 S;
float32_t  *inputF32, *outputF32;
 
/* 初始化输入输出缓存指针 */
inputF32 = &testInput_f32_50Hz_200Hz[0];
outputF32 = &testOutput[0];
 
/* 初始化结构体S */
arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP[0], &firStateF32[0], blockSize);
 
/* 实现FIR滤波 */ 
for(i=0; i < numBlocks; i++)
{
arm_fir_f32(&S, inputF32 + (i * blockSize), outputF32 + (i * blockSize), blockSize);
}
 
/* 打印滤波后结果 */
for(i = NUM_TAPS + NUM_TAPS /  2 ; i<TEST_LENGTH_SAMPLES; i++)
{
		sprintf(floatTOchar,"%.4f",testOutput[i]);
  	Usart_SendStr(DEBUG_USARTx,floatTOchar);
	  Usart_SendStr(DEBUG_USARTx,"\n");
    //printf("%f \r\n", testOutput[i]); //testInput_f32_50Hz_200Hz testOutput
}
/* 打印滤波后结果 */
for(i = NUM_TAPS ; i< NUM_TAPS + NUM_TAPS /  2; i++)
{
		sprintf(floatTOchar,"%.4f",testOutput[i]);
  	Usart_SendStr(DEBUG_USARTx,floatTOchar);
	  Usart_SendStr(DEBUG_USARTx,"\n");
    //printf("%f \r\n", testOutput[i]); //testInput_f32_50Hz_200Hz testOutput
}
}